#!/usr/bin/env ruby

$:.push File.join(File.dirname(__FILE__), '..'), File.join(File.dirname(__FILE__), '..','lib')

begin
  require 'bundler/setup'
  Bundler.require(:default)
rescue LoadError
  puts 'You must `gem install bundler` and `bundle install` to run rake tasks'
end

require 'jmeter/reports'

if ARGV.empty?
  puts "Usage: #{File.basename(__FILE__)} <report_file>"
  exit 1
end

begin
  if ARGV.size > 1
    table_data = []
    headers    = [:filename,:start,:end,:samples,:avg_thrput]
    ARGV.each do |filename|
      r = Jmeter::SummaryReport::Report.create(filename)
      table_data << { :filename => File.basename(filename), :start => r.start_date, :end => r.end_date, 
                      :samples => r.total_requests, :avg_thrput => "#{r.avg_throughput} RPS" }
    end
  else
    report = Jmeter::SummaryReport::Report.create(ARGV.first)
    puts ""
    puts "             Start: #{report.start_date}"
    puts "               End: #{report.end_date}"
    puts "          Duration: #{report.elapsed} secs"
    puts "    Total requests: #{report.total_requests}"
    puts "Overall throughput: #{report.avg_throughput} RPS"
    puts ""
    table_data = report.table_data
    headers = [:label,:reqs,:errors,:err_pct,:min,:avg,:max,:sd,:avg_thrput,:pct_90,:pct_95]
  end
  
  Formatador.display_compact_table(table_data, headers)

rescue Exception => e
  puts e.message
  exit 2
end
