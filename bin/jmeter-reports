#!/usr/bin/env ruby

$:.push File.join(File.dirname(__FILE__), '..'), File.join(File.dirname(__FILE__), '..','lib')

begin
  require 'bundler/setup'
  Bundler.require(:default)
rescue LoadError
  puts 'You must `gem install bundler` and `bundle install` to run rake tasks'
end

require 'jmeter/reports'

if ARGV.empty?
  puts "Usage: #{File.basename(__FILE__)} <report_file>"
  exit 1
end

begin
  if ARGV.size > 1
    puts "filename,elapsed,requests,avg_throughput"
    ARGV.each do |filename|
      r = Jmeter::SummaryReport::Report.create(filename)
      puts "#{filename},#{r.elapsed},#{r.total_requests},#{r.avg_throughput}"
    end
  else
    report = Jmeter::SummaryReport::Report.create(ARGV.first)
    puts ""
    puts "             Start: #{report.start_date}"
    puts "               End: #{report.end_date}"
    puts "          Duration: #{report.elapsed} secs"
    puts "    Total requests: #{report.total_requests}"
    puts "Average throughput: #{report.avg_throughput} RPS"
    puts ""
    Formatador.display_table(report.table_data, [:label,:reqs,:errors,:err_pct,:min,:avg,:max,:sd,:avg_thrput])
    puts ""
  end
rescue Exception => e
  puts e.message
  exit 2
end
